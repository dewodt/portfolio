---
import DetailAdjacentNavigation from "@/components/ui/detail/DetailAdjacentNavigation.astro";
import DetailBack from "@/components/ui/detail/DetailBack.astro";
import DetailDateRange from "@/components/ui/detail/DetailDateRange.astro";
import DetailDescription from "@/components/ui/detail/DetailDescription.astro";
import Divider from "@/components/ui/Divider.astro";
import DetailImage from "@/components/ui/detail/DetailImage.astro";
import DetailMonoLabel from "@/components/ui/detail/DetailMonoLabel.astro";
import PillDeployment from "@/components/ui/pill/PillDeployment.astro";
import PillRepository from "@/components/ui/pill/PillRepository.astro";
import DetailCompany from "@/components/ui/detail/DetailCompany.astro";
import DetailTitle from "@/components/ui/detail/DetailTitle.astro";
import CustomPortableText from "@/components/ui/portable-text/CustomPortableText.astro";
import LayoutBase from "@/layouts/LayoutBase.astro";
import {
  sanityClient,
  allExperiencesQuery,
  experienceDetailQuery,
} from "@/lib/query";
import {
  type AllExperiencesQueryResult,
  type ExperienceDetailQueryResult,
} from "@/types/sanity";

export const getStaticPaths = async () => {
  const allExperienceData =
    await sanityClient.fetch<AllExperiencesQueryResult>(allExperiencesQuery);

  const paths = allExperienceData.map((project) => ({
    params: {
      slug: project.slug.current,
    },
  }));

  return paths;
};

const experienceDetailData =
  await sanityClient.fetch<ExperienceDetailQueryResult>(experienceDetailQuery, {
    slug: Astro.params.slug,
  });

if (!experienceDetailData) {
  throw new Error("Data not found");
}
---

<LayoutBase
  title={`${experienceDetailData.title} at ${experienceDetailData.company} | Dewantoro Triatmojo`}
  description={experienceDetailData.description}
  linkPreviewImage={experienceDetailData.image}
>
  <main class="flex flex-auto justify-center px-5 py-12 sm:p-12 lg:p-16">
    <div class="flex w-full max-w-xl flex-col gap-6 lg:max-w-3xl lg:gap-8">
      {/* Back Button */}
      <div class="animate-fade-in-up opacity-0" style="animation-delay: 0.1s;">
        <DetailBack href="/experiences" label="Back to Experiences" />
      </div>

      <article class="flex flex-col gap-6 lg:gap-8">
        {/* Hero Image */}
        <div
          class="animate-fade-in-scale border-border/50 bg-surface relative overflow-hidden rounded-xl border opacity-0"
          style="animation-delay: 0.2s;"
        >
          <DetailImage
            src={experienceDetailData.image.url!}
            alt={experienceDetailData.image.alt}
          />
          <div
            class="from-background/40 pointer-events-none absolute inset-0 bg-gradient-to-t via-transparent to-transparent"
          >
          </div>
        </div>

        {/* Header Section */}
        <header class="flex flex-col">
          {/* Mono label */}
          <div
            class="animate-fade-in-up mb-1 opacity-0 lg:mb-2"
            style="animation-delay: 0.3s;"
          >
            <DetailMonoLabel
              >{experienceDetailData.detailMonoLabel}</DetailMonoLabel
            >
          </div>

          {/* Title */}
          <div
            class="animate-fade-in-up mb-2 opacity-0 lg:mb-3"
            style="animation-delay: 0.4s;"
          >
            <DetailTitle>{experienceDetailData.title}</DetailTitle>
          </div>

          {/* Description */}
          <div
            class="animate-fade-in-up mb-2 opacity-0 lg:mb-3"
            style="animation-delay: 0.5s;"
          >
            <DetailDescription
              >{experienceDetailData.description}</DetailDescription
            >
          </div>

          {/* Metadata row */}
          <div
            class="animate-fade-in-up flex flex-wrap items-center gap-3 opacity-0"
            style="animation-delay: 0.6s;"
          >
            <DetailCompany company={experienceDetailData.company} />
            <span class="text-muted text-sm lg:text-base">&middot;</span>
            <DetailDateRange
              dateRange={experienceDetailData.dateRange}
              isEmptyEndDateShowNow={true}
            />

            {
              (experienceDetailData.repositoryLinks?.length ||
                experienceDetailData.deploymentLinks?.length) && (
                <span class="text-muted text-sm lg:text-base">&middot;</span>
              )
            }

            {
              experienceDetailData.repositoryLinks?.map((repo) => (
                <PillRepository repository={repo} />
              ))
            }

            {
              experienceDetailData.deploymentLinks?.map((deploy) => (
                <PillDeployment deployment={deploy} />
              ))
            }
          </div>
        </header>

        {/* Divider */}
        <div
          class="animate-fade-in-up opacity-0"
          style="animation-delay: 0.7s;"
        >
          <Divider />
        </div>

        {/* Content Section */}
        <section
          class="animate-fade-in-up w-full opacity-0"
          style="animation-delay: 0.8s;"
        >
          {
            (
              // @ts-ignore
              <CustomPortableText value={experienceDetailData.content} />
            )
          }
        </section>

        {/* Adjacent Navigation */}
        <div
          class="animate-fade-in-up opacity-0"
          style="animation-delay: 0.9s;"
        >
          <Divider />
        </div>
        <div
          class="animate-fade-in-up opacity-0"
          style="animation-delay: 1.0s;"
        >
          <DetailAdjacentNavigation
            previous={experienceDetailData.previous && {
              title: `${experienceDetailData.previous.title} @ ${experienceDetailData.previous.company}`,
              href: `/experiences/${experienceDetailData.previous.slug.current}`,
              description: experienceDetailData.previous.description,
            }}
            next={experienceDetailData.next && {
              title: `${experienceDetailData.next.title} @ ${experienceDetailData.next.company}`,
              href: `/experiences/${experienceDetailData.next.slug.current}`,
              description: experienceDetailData.next.description,
            }}
          />
        </div>
      </article>
    </div>
  </main>
</LayoutBase>
