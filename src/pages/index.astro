---
import LayoutBase from "../layouts/LayoutBase.astro";
import { Image } from "astro:assets";
import type { AboutPageQueryResult } from "@/types/sanity";
import CustomPortableText from "@/components/ui/portable-text/CustomPortableText.astro";
import { sanityClient, aboutPageQuery } from "@/lib/query";
import { toPlainText } from "astro-portabletext";
import Divider from "@/components/ui/Divider.astro";
import SkillBadge from "@/components/ui/badge/SkillBadge.astro";
import MapPinIcon from "@/components/icons/MapPinIcon.astro";
import CardEducation from "@/components/ui/card/CardEducation.astro";
import type { PortableTextBlock } from "@portabletext/types";

// Get about page data
const aboutPageData =
  await sanityClient.fetch<AboutPageQueryResult>(aboutPageQuery);
if (!aboutPageData) {
  throw new Error("About data not found");
}

// Cast content to PortableTextBlock array for type safety
const portableTextContent = aboutPageData.content as PortableTextBlock[];
---

<LayoutBase
  title={aboutPageData.title}
  description={toPlainText(portableTextContent)}
>
  <main class="flex flex-auto flex-col gap-16 sm:gap-24">
    <!-- Hero -->
    <section
      class="relative mb-[78px] flex min-h-[calc(100vh-74px-78px)] flex-auto items-center justify-center px-5 py-12 sm:min-h-[calc(100vh-66px-78px)] sm:p-12 lg:p-14"
      data-scroll-section
    >
      <div
        class="relative flex flex-col items-center gap-6 md:flex-row-reverse md:gap-10 lg:gap-16 xl:gap-24"
      >
        {/* My Photo */}
        <div
          class="relative"
          data-scroll="fade-in-scale"
          style="animation-delay: 0.1s;"
        >
          {/* Ambient glow layer 1 */}
          <div
            class="bg-primary/20 animate-pulse-glow absolute -inset-6 rounded-[20%] blur-3xl"
            aria-hidden="true"
          >
          </div>
          {/* Ambient glow layer 2 */}
          <div
            class="bg-accent/15 animate-pulse-glow absolute -inset-3 rounded-[20%] blur-2xl"
            style="animation-delay: 1.5s;"
            aria-hidden="true"
          >
          </div>
          {/* Photo */}
          <Image
            class="border-border/50 bg-card text-secondary relative flex size-56 items-center justify-evenly rounded-[20%] border text-base font-medium lg:size-80"
            src={aboutPageData.image.url!}
            alt={aboutPageData.image.alt}
            widths={[224, 320, 512]}
            sizes="(max-width: 1023px) 224px, 320px"
            loading="eager"
            inferSize
          />
        </div>

        {/* Texts */}
        {/* Need to override default margin from portable text */}
        <div
          class="flex max-w-xs flex-col text-center md:max-w-108 md:text-start lg:max-w-lg"
        >
          {/* Engineer label + Location */}
          <div
            class="mb-2 flex flex-col items-center gap-1.5 font-mono text-xs tracking-widest uppercase md:flex-row md:gap-0 lg:mb-3 lg:text-sm"
            data-scroll="fade-in-up"
            style="animation-delay: 0.2s;"
          >
            <span class="text-primary">{aboutPageData.heroMonoLabel}</span>
            <span class="text-muted hidden md:inline">&nbsp;Â·&nbsp;</span>
            <span class="text-muted flex items-center gap-1 lg:gap-1.5">
              <MapPinIcon class="size-3 lg:size-3.5" />
              {aboutPageData.location}
            </span>
          </div>

          {/* Title */}
          <h1
            class="text-secondary mb-3 text-3xl font-bold tracking-tight lg:mb-4 lg:text-5xl"
            data-scroll="fade-in-up"
            style="animation-delay: 0.3s;"
          >
            {aboutPageData.title}
          </h1>

          {/* Paragraph */}
          <div
            class="*:my-0 *:lg:my-0"
            data-scroll="fade-in-up"
            style="animation-delay: 0.4s;"
          >
            <CustomPortableText value={portableTextContent} />
          </div>
        </div>
      </div>
    </section>

    {/* Section divider */}
    <div data-scroll-section>
      <div data-scroll="fade-in-up" style="animation-delay: 0.1s;">
        <Divider class="mx-auto max-w-xs sm:max-w-2xl lg:max-w-4xl" />
      </div>
    </div>

    <!-- Education -->
    <section
      class="flex flex-auto justify-center px-5 py-12 sm:p-12 lg:p-14"
      data-scroll-section
    >
      <div class="flex w-full max-w-3xl flex-col gap-6">
        <div class="flex flex-col text-center">
          <span
            class="text-primary mb-1 font-mono text-xs tracking-widest uppercase lg:mb-2 lg:text-sm"
            data-scroll="fade-in-up"
            style="animation-delay: 0.1s;"
          >
            {aboutPageData.educationMonoLabel}
          </span>
          <h2
            class="text-secondary mb-2 text-2xl font-bold tracking-tight lg:mb-3 lg:text-3xl"
            data-scroll="fade-in-up"
            style="animation-delay: 0.2s;"
          >
            {aboutPageData.educationSectionTitle}
          </h2>
          <p
            class="text-muted text-base lg:text-lg"
            data-scroll="fade-in-up"
            style="animation-delay: 0.3s;"
          >
            {aboutPageData.educationSectionDescription}
          </p>
        </div>

        {/* Timeline */}
        <div class="relative w-full">
          {/* Continuous vertical line */}
          <div
            class="bg-border absolute top-0 bottom-0 left-[5px] w-px origin-top"
            data-scroll="grow-down"
            style="animation-delay: 0.3s;"
          >
          </div>

          <ul class="flex flex-col gap-6 lg:gap-8">
            {
              aboutPageData.education.map((edu, index) => (
                <li
                  class="relative pl-8 lg:pl-10"
                  data-scroll="fade-in-up"
                  style={`animation-delay: ${0.4 + index * 0.1}s;`}
                >
                  {/* Timeline dot */}
                  <div class="bg-primary ring-background absolute top-5 left-0 z-10 size-3 rounded-full ring-4" />
                  <CardEducation
                    image={edu.image.url!}
                    imageAlt={edu.image.alt}
                    degree={edu.degree}
                    university={edu.university}
                    startDate={edu.dateRange.startDate}
                    endDate={edu.dateRange.endDate}
                    description={edu.description}
                  />
                </li>
              ))
            }
          </ul>
        </div>
      </div>
    </section>

    {/* Section divider */}
    <div data-scroll-section>
      <div data-scroll="fade-in-up" style="animation-delay: 0.1s;">
        <Divider class="mx-auto max-w-xs sm:max-w-2xl lg:max-w-4xl" />
      </div>
    </div>

    <!-- Skills -->
    <section
      class="flex flex-auto justify-center px-5 py-12 sm:p-12 lg:p-14"
      data-scroll-section
    >
      <div class="flex w-full max-w-3xl flex-col gap-6">
        <div class="flex flex-col text-center">
          <span
            class="text-primary mb-1 font-mono text-xs tracking-widest uppercase lg:mb-2 lg:text-sm"
            data-scroll="fade-in-up"
            style="animation-delay: 0.1s;"
          >
            {aboutPageData.skillsMonoLabel}
          </span>
          <h2
            class="text-secondary mb-2 text-2xl font-bold tracking-tight lg:mb-3 lg:text-3xl"
            data-scroll="fade-in-up"
            style="animation-delay: 0.2s;"
          >
            {aboutPageData.skillsSectionTitle}
          </h2>
          <p
            class="text-muted text-base lg:text-lg"
            data-scroll="fade-in-up"
            style="animation-delay: 0.3s;"
          >
            {aboutPageData.skillsSectionDescription}
          </p>
        </div>

        <div class="space-y-10">
          {
            aboutPageData.skillCategories.map((category, categoryIndex) => (
              <div
                class="space-y-4"
                data-scroll="fade-in-up"
                style={`animation-delay: ${0.4 + categoryIndex * 0.1}s;`}
              >
                <h3 class="text-muted text-center font-mono text-xs tracking-widest uppercase lg:text-sm">
                  {category.categoryTitle}
                </h3>
                <ul class="flex flex-row flex-wrap justify-center gap-2.5">
                  {category.skills.map((skill) => (
                    <li>
                      <SkillBadge
                        logoLight={skill.logoLight!}
                        logoDark={skill.logoDark!}
                        title={skill.title}
                      />
                    </li>
                  ))}
                </ul>
              </div>
            ))
          }
        </div>
      </div>
    </section>
  </main>
</LayoutBase>
