---
import { Image } from "astro:assets";
import ArrowRightIcon from "@/components/icons/ArrowRightIcon.astro";
import PillRepository from "@/components/ui/pill/PillRepository.astro";
import PillDeployment from "@/components/ui/pill/PillDeployment.astro";
import { getFormattedDate } from "@/lib/utils";
import type { AllExperiencesQueryResult } from "@/types/sanity";

interface Props {
  experience: AllExperiencesQueryResult[number];
}

const { experience } = Astro.props;

const startFormatted = getFormattedDate(experience.dateRange.startDate);
const endFormatted = experience.dateRange.endDate
  ? getFormattedDate(experience.dateRange.endDate)
  : "Present";
---

<article
  class="group/card border-border bg-card hover:border-border-hover/80 hover:drop-shadow-primary-sm relative overflow-hidden rounded-xl border transition-all duration-300 hover:-translate-y-1"
>
  {/* Gradient glow pseudo-element */}
  <div
    class="bg-primary/0 group-hover/card:bg-primary/15 pointer-events-none absolute -inset-px -z-10 rounded-xl blur-xl transition-all duration-500"
  >
  </div>

  {/* Full-card anchor */}
  <a
    href={`/experiences/${experience.slug.current}`}
    aria-label={`Link to experience ${experience.title} at ${experience.company}`}
    class="absolute inset-0 z-30"></a>

  <div class="flex gap-3 p-4 lg:gap-4">
    {/* Company image thumbnail */}
    <div
      class="flex aspect-square size-12 shrink-0 items-center justify-center overflow-hidden rounded-lg bg-white lg:size-14"
    >
      <Image
        class="text-secondary h-auto w-full object-contain text-xs font-medium"
        src={experience.image.url!}
        alt={experience.image.alt}
        widths={[48, 56, 96, 112]}
        sizes="(max-width: 1023px) 48px, 56px"
        inferSize
      />
    </div>

    {/* Content */}
    <div class="flex flex-1 flex-col">
      {/* Company mono label */}
      <span
        class="text-primary mb-0.5 font-mono text-xs tracking-widest uppercase"
      >
        {experience.company}
      </span>

      {/* Title + arrow */}
      <div class="mb-2 flex items-center gap-2">
        <h2
          class="text-secondary group-hover/card:text-primary text-lg font-bold transition-colors duration-200 lg:text-xl"
        >
          {experience.title}
        </h2>
        <ArrowRightIcon
          class="text-primary size-4 shrink-0 -translate-x-1 opacity-0 transition-all duration-200 group-hover/card:translate-x-0 group-hover/card:opacity-100"
        />
      </div>

      {/* Date range */}
      <span
        class="text-muted-foreground mb-2 font-mono text-xs tracking-widest uppercase"
      >
        <time datetime={experience.dateRange.startDate}>{startFormatted}</time>
        {" â€“ "}
        {
          experience.dateRange.endDate ? (
            <time datetime={experience.dateRange.endDate}>{endFormatted}</time>
          ) : (
            <span>Present</span>
          )
        }
      </span>

      {/* Description */}
      <p class="text-muted mb-2 text-sm whitespace-pre-line">
        {experience.description}
      </p>

      {/* Pill links */}
      {
        (experience.repositoryLinks || experience.deploymentLinks) && (
          <div class="z-40 flex flex-wrap gap-2">
            {experience.repositoryLinks?.map((repo) => (
              <PillRepository repository={repo} />
            ))}
            {experience.deploymentLinks?.map((deploy) => (
              <PillDeployment deployment={deploy} />
            ))}
          </div>
        )
      }
    </div>
  </div>
</article>
